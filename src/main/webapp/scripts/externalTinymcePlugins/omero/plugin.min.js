tinymce.PluginManager.add('omero', function (editor, url) {

    editor.addCommand("cmdOmero", function () {
        editor.windowManager.openUrl({
            title: "Insert from Omero",
            url: url + "/dialog.html",
            width: 2100,
            height: 1200,
            buttons: [
                {
                    type: "cancel",
                    text: "Cancel"
                },
                {
                    type: "custom",
                    name: "insert",
                    text: "Insert",
                    primary: true
                }
            ],
            onAction(dialogApi, button) {
                if (button.name == "insert") {
                    editor.fire("omero-insert");
                    RS.trackEvent('OmeroDataInserted');
                }
            },
            onClose() {
                RS.showHelpButton();
            },
            onMessage(dialogApi, details) {
                let button = $("button[title='Insert']");
                const buttonBlock = $(".tox-dialog__footer");
                buttonBlock.css("display","block");
                if (details.mceAction == "disable") {
                    button.attr("disabled", "disabled");
                } else if (details.mceAction == "enable") {
                    button.prop("disabled", null);
                    button.removeAttr("disabled");
                }
            }
        });
    });
    editor.addCommand('cmdOmero__dropboxcopy', function () {
        editor.ui.registry.addButton('omero', {
            tooltip: 'Insert from Omero',
            icon: 'omero',
            onAction: function () {
                apprise('Unable to contact Omero. Please try again later or ensure that your network connection is active and reload the page.');
            }
        });

        editor.ui.registry.addMenuItem('optOmero', {
            text: 'From Omero',
            icon: 'omero',
            onAction: function () {
                apprise('Unable to contact Omero.  Please try again later or ensure that your network connection is active and reload the page.');
            }
        });
    });

    editor.ui.registry.addButton('omero', {
        icon: 'omero',
        tooltip: 'Insert from Omero',
        onAction: function () {
            editor.execCommand("cmdOmero");
        },
    });

    editor.ui.registry.addMenuItem('optOmero', {
        text: 'From Omero',
        icon: 'omero',
        onAction: function () {
            editor.execCommand("cmdOmero");
        },
    });
});
