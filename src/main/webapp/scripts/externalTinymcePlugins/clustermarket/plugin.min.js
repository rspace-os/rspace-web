tinymce.PluginManager.add('clustermarket', function (editor, url) {

    editor.addCommand("cmdClusterMarket", function () {
        editor.windowManager.openUrl({
            title: "Insert from Clustermarket",
            url: url + "/dialog.html",
            width: 1400,
            height: 800,
            buttons: [
                {
                    type: "cancel",
                    text: "Cancel"
                },
                {
                    type: "custom",
                    name: "insert",
                    text: "Insert",
                    primary: true
                }
            ],
            onAction(dialogApi, button) {
                if (button.name == "insert") {
                    editor.fire("clustermarket-insert");
                    RS.trackEvent('ClustermarketDataInserted');
                }
            },
            onClose() {
            },
            onMessage(dialogApi, details) {
                let button = $("button[title='Insert']");
                if (details.mceAction == "disable") {
                    button.attr("disabled", "disabled");
                } else if (details.mceAction == "enable") {
                    button.prop("disabled", null);
                    button.removeAttr("disabled");
                }
            }
        });
    });
    editor.addCommand('cmdClusterMarket__dropboxcopy', function () {
        // if (typeof Dropbox === 'object') {
        //   Dropbox.appKey = 'fe4ktl7kwhho28d';
        //   Dropbox.choose(options);
        // } else {
        editor.ui.registry.addButton('clustermarket', {
            tooltip: 'Insert from Clustermarket',
            icon: 'clustermarket',
            onAction: function () {
                apprise('Unable to contact Clustermarket. Please try again later or ensure that your network connection is active and reload the page.');
            }
        });

        editor.ui.registry.addMenuItem('optClustermarket', {
            text: 'From Clustermarket',
            icon: 'clustermarket',
            onAction: function () {
                apprise('Unable to contact Clustermarket.  Please try again later or ensure that your network connection is active and reload the page.');
            }
        });

        if(!window.insertActions) window.insertActions = new Map();
        window.insertActions.set("optClustermarket", {
          text: 'From Clustermarket',
          icon: 'clustermarket',
          action: () => {
            apprise('Unable to contact Clustermarket.  Please try again later or ensure that your network connection is active and reload the page.');
          },
        });
        // }
    });

    editor.ui.registry.addButton('clustermarket', {
        icon: 'clustermarket',
        tooltip: 'Insert from Clustermarket',
        onAction: function () {
            editor.execCommand("cmdClusterMarket");
        },
    });

    editor.ui.registry.addMenuItem('optClustermarket', {
        text: 'From Clustermarket',
        icon: 'clustermarket',
        onAction: function () {
            editor.execCommand("cmdClusterMarket");
        },
    });

    if(!window.insertActions) window.insertActions = new Map();
    window.insertActions.set("optClustermarket", {
      text: 'From Clustermarket',
      icon: 'clustermarket',
      action: () => {
        editor.execCommand("cmdClusterMarket");
      },
    });
});
